version: 2
jobs:
  build:
    working_directory: /var/www/code
    docker:
      - image: lastcallmedia/php:7.0-dev # Primary image
        environment:
          DOCKER_ENV: ci
          APACHE_DOCROOT: /var/www/code/web
          MYSQL_USER: circle
          MYSQL_PASSWORD: circle
          MYSQL_DATABASE: circle
          MYSQL_HOST: circle
      - image: lastcallmedia/php:7.0-dev # Web container
        environment:
          DOCKER_ENV: ci
          APACHE_DOCROOT: /var/www/code/web
          MYSQL_USER: circle
          MYSQL_PASSWORD: circle
          MYSQL_DATABASE: circle
          MYSQL_HOST: circle
      - image: mysql:5.6
        environment:
          MYSQL_USER: circle
          MYSQL_PASSWORD: circle
          MYSQL_DATABASE: circle
          MYSQL_RANDOM_ROOT_PASSWORD: 1
    steps:
      - checkout
      - restore_cache:
          name: Restore NPM cache
          keys:
            - site-npm-{{ checksum "package.json" }}
            - site-npm-
      - run: {name: "NPM install", command: "npm install" }
      - save_cache:
          name: Save NPM cache
          key: site-npm-{{ checksum "package.json" }}
          paths: [ node_modules ]
      - restore_cache:
          name: Restore Composer cache
          keys:
            - site-composer-{{ checksum "composer.lock" }}
            - site-composer
      - run: {name: "Gulp install", command: "gulp install" }
      - save_cache:
          name: Save Composer cache
          key: site-composer-{{ checksum "composer.lock" }}
          paths: [ vendor ]
      - run: {name: "Execute build", command: "gulp build" }
      - run: {name: "Check code", command: "gulp check" }
      - run:
          name: "Prepare site"
          command: |
            vendor/bin/drupal chain --file=$(pwd)/ci/prepare-site.yml
      - run: {name: "Execute tests", command: "gulp test --base-url='http://127.0.0.1'" }

workflows:
  version: 2
  build_test_release:
    jobs:
      - build
